{"id":"node_modules/@vibrant/worker/lib/pool.js","dependencies":[{"name":"/Users/christianreindl/Code/fenwick-ui/node_modules/@vibrant/worker/lib/pool.js.map","includedInParent":true,"mtime":499162500000},{"name":"/Users/christianreindl/Code/fenwick-ui/package.json","includedInParent":true,"mtime":1628308770203},{"name":"/Users/christianreindl/Code/fenwick-ui/node_modules/@vibrant/worker/package.json","includedInParent":true,"mtime":499162500000},{"name":"@vibrant/types","loc":{"line":14,"column":22},"parent":"/Users/christianreindl/Code/fenwick-ui/node_modules/@vibrant/worker/lib/pool.js","resolved":"/Users/christianreindl/Code/fenwick-ui/node_modules/@vibrant/types/lib/index.js"}],"generated":{"js":"\"use strict\";\nvar __rest = (this && this.__rest) || function (s, e) {\n    var t = {};\n    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)\n        t[p] = s[p];\n    if (s != null && typeof Object.getOwnPropertySymbols === \"function\")\n        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {\n            if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))\n                t[p[i]] = s[p[i]];\n        }\n    return t;\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar types_1 = require(\"@vibrant/types\");\n// const WorkerClass: TaskWorkerClass = require('worker-loader?inline=true!./worker')\nvar MAX_WORKER_COUNT = 5;\nvar WorkerPool = /** @class */ (function () {\n    function WorkerPool(WorkerClass) {\n        this.WorkerClass = WorkerClass;\n        this._taskId = 0;\n        this._workers = [];\n        this._queue = [];\n        this._executing = {};\n    }\n    WorkerPool.prototype._findIdleWorker = function () {\n        var worker;\n        // if no idle worker && worker count < max count, make new one\n        if (this._workers.length === 0 || this._workers.length < MAX_WORKER_COUNT) {\n            worker = new this.WorkerClass();\n            worker.id = this._workers.length;\n            worker.idle = true;\n            this._workers.push(worker);\n            worker.onmessage = this._onMessage.bind(this, worker.id);\n        }\n        else {\n            worker = this._workers.find(function (_a) {\n                var idle = _a.idle;\n                return idle;\n            });\n        }\n        return worker;\n    };\n    WorkerPool.prototype._enqueue = function (payload, transferList) {\n        var d = types_1.defer();\n        // make task item\n        var task = {\n            id: this._taskId++,\n            payload: payload,\n            transferList: transferList,\n            deferred: d\n        };\n        this._queue.push(task);\n        // Try dequeue\n        this._tryDequeue();\n        return d.promise;\n    };\n    WorkerPool.prototype._tryDequeue = function () {\n        // Called when a work has finished or from _enqueue\n        // No pending task\n        if (this._queue.length <= 0)\n            return;\n        // Find idle worker\n        var worker = this._findIdleWorker();\n        // No idle worker\n        if (!worker)\n            return;\n        // Dequeue task\n        var task = this._queue.shift();\n        this._executing[task.id] = task;\n        // Send payload\n        var transfers = task.transferList;\n        var deferred = task.deferred, transferList = task.transferList, request = __rest(task, [\"deferred\", \"transferList\"]);\n        worker.postMessage(request, transfers);\n        worker.idle = false;\n    };\n    WorkerPool.prototype._onMessage = function (workerId, event) {\n        var data = event.data;\n        if (!data)\n            return;\n        // Worker should send result along with payload id\n        var id = data.id;\n        // Task is looked up by id\n        var task = this._executing[id];\n        delete this._executing[id];\n        // Resolve or reject deferred promise\n        switch (data.type) {\n            case 'return':\n                task.deferred.resolve(data.payload);\n                break;\n            case 'error':\n                task.deferred.reject(new Error(data.payload));\n                break;\n        }\n        // Update worker status\n        this._workers[workerId].idle = true;\n        // Try dequeue next task\n        this._tryDequeue();\n    };\n    WorkerPool.prototype.invoke = function (args, transferList) {\n        return this._enqueue(args, transferList);\n    };\n    return WorkerPool;\n}());\nexports.default = WorkerPool;\n"},"sourceMaps":{"js":{"version":3,"file":"pool.js","sourceRoot":"","sources":["../../../../packages/vibrant-worker/src/pool.ts"],"names":[],"mappings":"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","sourcesContent":[null]}},"error":null,"hash":"60eb52a3080c2e03d8bd78fc5b5cd743","cacheData":{"env":{}}}